---
- name: Add helm chart repo
  become: no
  command: helm repo add ory https://k8s.ory.sh/helm/charts
  changed_when: false

- name: Update helm repo
  become: no
  command: helm repo update
  changed_when: false

- name: Copy Hydra files
  copy:
    src: files/
    dest: /tmp/hydra
    owner: ubuntu
    group: ubuntu
  changed_when: false

- name: Create namespace hydra-system
  become: no
  command: kubectl apply -f /tmp/hydra/namespace.yaml
  changed_when: false

- name: Install Hydra 
  become: no
  shell: > 
    helm template /tmp/hydra/hydra --name hydra --namespace hydra-system | kubectl apply -f -
  changed_when: false

- name: Create gateway hydra-system
  become: no
  command: kubectl apply -f /tmp/hydra/gateway.yml
  changed_when: false